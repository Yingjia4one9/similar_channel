# YouTube 相似频道查找系统 - 使用指南

## 📋 目录

1. [环境要求](#环境要求)
2. [安装步骤](#安装步骤)
3. [配置 API Key](#配置-api-key)
4. [构建频道索引（可选）](#构建频道索引可选)
5. [启动服务](#启动服务)
6. [使用方式](#使用方式)
7. [常见问题](#常见问题)

---

## 🔧 环境要求

- **Python**: 3.8 或更高版本
- **操作系统**: Windows / Linux / macOS
- **网络**: 需要能够访问 YouTube API 和下载模型

---

## 📦 安装步骤

### 1. 安装 Python 依赖

```bash
pip install -r requirements.txt
```

**依赖说明**：
- `fastapi` - Web API 框架
- `uvicorn` - ASGI 服务器
- `sentence-transformers` - 文本向量化模型
- `faiss-cpu` - 高效向量搜索（可选，但强烈推荐）
- `numpy` - 数值计算
- `requests` - HTTP 请求

> ⚠️ 注意：首次运行时会自动下载 `intfloat/multilingual-e5-base` 模型（约 400MB），需要一定时间。

### 2. （可选）安装 Faiss GPU 版本

如果你的系统有 NVIDIA GPU 且已安装 CUDA，可以安装 GPU 版本以获得更快速度：

```bash
pip uninstall faiss-cpu
pip install faiss-gpu
```

---

## 🔑 配置 API Key

### 方法 1：使用文件（推荐）

1. 创建文件 `YouTube api key.txt`
2. 将你的 YouTube Data API v3 Key 写入该文件（仅一行，不包含引号）
3. 保存文件

```
AIzaSy...你的API密钥
```

### 方法 2：使用环境变量

```bash
# Windows (PowerShell)
$env:YT_API_KEY="你的API密钥"

# Windows (CMD)
set YT_API_KEY=你的API密钥

# Linux/macOS
export YT_API_KEY="你的API密钥"
```

### 获取 YouTube API Key

1. 访问 [Google Cloud Console](https://console.cloud.google.com/)
2. 创建新项目或选择现有项目
3. 启用 "YouTube Data API v3"
4. 创建凭据（API Key）
5. 复制 API Key

> 💡 **配额说明**：免费配额为每天 10,000 单位。一次完整的相似频道查找约消耗 20,000+ 单位，建议申请配额提升。

---

## 🗄️ 构建频道索引（可选）

构建本地索引可以：
- ✅ 大幅提升搜索速度（10-100倍）
- ✅ 减少 API 调用，节省配额
- ✅ 支持离线搜索（部分功能）

### 基本用法

```bash
python build_channel_index.py
```

### 自定义配置

编辑 `build_channel_index.py` 文件，修改以下部分：

```python
# 1. 设置种子频道（你已知的优质频道）
raw_seed_channels: List[str] = [
    "https://www.youtube.com/@Crypto621",
    "https://www.youtube.com/@bitraderx",
    # 添加更多频道链接...
]

# 2. 设置搜索关键词
default_keywords = [
    "crypto trading",
    "bitcoin",
    "ethereum",
    # 添加更多关键词...
]

# 3. 调整参数
build_index(
    seed_channel_ids=seed_channels, 
    keywords=default_keywords,
    max_workers=5,      # 并行线程数（根据网络和配额调整）
    batch_size=20,      # 批量提交大小
)
```

### 构建索引所需时间

- **100 个频道**: 约 5-10 分钟
- **1000 个频道**: 约 50-100 分钟
- **10,000 个频道**: 约 8-16 小时

> ⏱️ **提示**：索引构建完成后，数据存储在 `channel_index.db` 文件中，后续使用无需重新构建。

---

## 🚀 启动服务

### 推荐方式：使用启动脚本 ⭐

直接双击项目根目录下的 `start.bat` 文件即可启动服务。

**优势**：
- ✅ 一键启动，无需输入命令
- ✅ 自动切换到项目目录
- ✅ 显示友好的启动信息
- ✅ 服务停止后窗口保持打开（方便查看日志）

### 其他启动方式

开发环境可使用：`uvicorn main:app --reload --host 0.0.0.0 --port 8000`  
或：`python -m uvicorn main:app --host 0.0.0.0 --port 8000`

### 访问 API 文档

启动后访问：http://localhost:8000/docs（可查看所有 API 接口、在线测试、查看请求/响应格式）

---

## 📱 使用方式

### 1. Web API 方式

#### 基本请求示例

```bash
curl -X POST "http://localhost:8000/similar-channels" \
  -H "Content-Type: application/json" \
  -d '{
    "channel_url": "https://www.youtube.com/@Crypto621",
    "max_results": 20
  }'
```

#### Python 示例

```python
import requests

response = requests.post(
    "http://localhost:8000/similar-channels",
    json={
        "channel_url": "https://www.youtube.com/@Crypto621",
        "max_results": 20,
        "min_subscribers": 1000,  # 最小订阅数
        "preferred_language": "en"  # 偏好语言
    }
)

results = response.json()
print(f"找到 {len(results['similar_channels'])} 个相似频道")
for channel in results['similar_channels']:
    print(f"- {channel['title']}: {channel['similarity']:.2%} 相似度")
```

#### 请求参数说明

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `channel_url` | string | ✅ | YouTube 频道链接（支持多种格式） |
| `max_results` | int | ❌ | 最大返回结果数（1-200，默认20） |
| `min_subscribers` | int | ❌ | 最小订阅数筛选 |
| `max_subscribers` | int | ❌ | 最大订阅数筛选 |
| `preferred_language` | string | ❌ | 偏好语言（如 "en", "zh-Hans"） |
| `preferred_region` | string | ❌ | 偏好地区（如 "US", "CN"） |
| `min_similarity` | float | ❌ | 最低相似度（0-1） |

#### 支持的频道 URL 格式

- `https://www.youtube.com/channel/UCxxxxx`
- `https://youtube.com/@handle`
- `https://youtube.com/user/USERNAME`
- `https://youtube.com/c/CUSTOM_NAME`
- `https://www.youtube.com/watch?v=VIDEO_ID`（视频链接）

### 2. 前端网页方式

1. 打开 `frontend.html` 文件（用浏览器直接打开或部署到服务器）
2. 在输入框中输入频道链接
3. 设置筛选条件（可选）
4. 点击搜索按钮
5. 等待结果加载（会显示进度）

### 3. Chrome 扩展方式

支持两种模式：
- **侧边栏模式**（推荐）：在 YouTube 频道页面右侧自动显示相似频道
- **弹窗模式**：点击扩展图标，输入频道链接搜索

**安装和使用**：详细说明请参考 `chrome-extension/README.md`

### 4. CSV 导出

```bash
curl -X POST "http://localhost:8000/similar-channels/export" \
  -H "Content-Type: application/json" \
  -d '{
    "channel_url": "https://www.youtube.com/@Crypto621",
    "max_results": 50
  }' \
  > results.csv
```

导出的 CSV 文件包含：
- 频道标题、链接
- 订阅数、观看数
- 相似度分数
- 邮箱地址

### 5. 流式响应（带进度）

适用于需要实时查看搜索进度的场景：

```python
import requests
import json

response = requests.post(
    "http://localhost:8000/similar-channels/stream",
    json={"channel_url": "https://www.youtube.com/@Crypto621"},
    stream=True
)

for line in response.iter_lines():
    if line:
        data = line.decode('utf-8')
        if data.startswith('data: '):
            event = json.loads(data[6:])
            if event['type'] == 'progress':
                print(f"进度: {event['progress']}% - {event['message']}")
            elif event['type'] == 'result':
                results = event['data']
                print(f"找到 {len(results['similar_channels'])} 个相似频道")
```

---

## ❓ 常见问题

### Q1: API 配额不足或搜索速度慢？

**A**: 
1. **优先使用本地索引**（最重要）：运行 `build_channel_index.py` 构建本地索引，可提升 10-100 倍速度并减少 API 调用
2. 申请增加 API 配额或使用多个 API Key 轮换
3. 安装 `faiss-gpu`（如果有 GPU）以提升搜索速度
4. 减少 `max_results` 数量

### Q2: 找不到相似频道或模型下载失败？

**A**:
- **找不到相似频道**：确保频道有公开视频，尝试放宽筛选条件，检查网络连接和日志
- **模型下载失败**：检查网络连接，尝试使用代理，或手动下载模型到本地后指定路径

### Q3: 如何更新本地索引？

**A**: 直接运行 `build_channel_index.py`，程序会自动检测需要更新的频道（超过7天的数据），跳过已是最新的频道，并行处理提高效率。

### Q4: 相似度评分如何计算？

**A**: 综合评分 = 45% 标签相似度 + 40% 语义相似度 + 15% 订阅量级得分

- **标签相似度**：基于 Topics 和 Audience 标签的重合度
- **语义相似度**：使用 embedding 模型计算的余弦相似度
- **订阅量级**：基于订阅数数量级的接近程度

**注意**：系统使用多语言模型，支持所有语言的频道。可以设置 `preferred_language` 参数来筛选特定语言。

---

## 📊 性能优化建议

1. **构建本地索引**：这是最重要的优化，可以提升 10-100 倍速度（详见[构建频道索引](#构建频道索引可选)部分）
2. **使用 Faiss**：已自动使用，如果没有安装会自动回退到原始方法
3. **调整并发数**：在 `build_channel_index.py` 中调整 `max_workers`
4. **合理设置候选数量**：`max_results` 不要设置过大（建议 20-50）

---

## 🛠️ 高级配置

### 修改模型

编辑 `config.py`：

```python
EMBED_MODEL_NAME = "intfloat/multilingual-e5-base"  # 可替换为其他模型
```

### 自定义标签

编辑 `config.py`，修改 `TOPIC_LABELS` 和 `AUDIENCE_LABELS`：

```python
TOPIC_LABELS: List[str] = [
    "bitcoin",
    "ethereum",
    # 添加你的自定义标签...
]
```

### 调整相似度权重

编辑 `config.py`：

```python
SIMILARITY_WEIGHTS = {
    "tag_score": 0.45,      # 标签相似度权重
    "semantic_sim": 0.40,    # 语义相似度权重
    "scale_score": 0.15,     # 订阅量级权重
}
```

---

## 📝 日志查看

程序运行时会输出详细日志，包括：
- API 调用状态
- 错误信息
- 性能指标
- 进度更新

日志级别可以通过修改 `logger.py` 调整。

---

## 🔒 安全建议

1. **保护 API Key**：不要将 `YouTube api key.txt` 提交到版本控制
2. **使用环境变量**：生产环境建议使用环境变量
3. **限制访问**：生产环境建议添加认证和访问限制
4. **监控配额**：定期检查 API 配额使用情况

---

## 📞 获取帮助

如果遇到问题：
1. 查看日志文件了解详细错误
2. 检查 API Key 是否正确配置
3. 确认网络连接正常
4. 查看 `chrome-extension/TROUBLESHOOTING.md`（Chrome 扩展相关问题）

---

## 🎯 使用场景

1. **频道主寻找相似频道**：用于合作、竞品分析
2. **内容发现**：找到感兴趣的相关频道
3. **市场研究**：分析特定领域的频道生态
4. **商务合作**：系统会自动提取频道邮箱

---

祝使用愉快！🚀

