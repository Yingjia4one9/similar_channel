# y3：配额管理检查清单

## 一、规范定义（工程化）

**配额管理（Quota Management）**：系统应有效管理 YouTube API 配额，确保在配额限制内最大化系统可用性和功能完整性。

**工程化含义**：
- 实时跟踪配额使用情况
- 在配额耗尽前提前告警
- 配额接近限制时自动限流
- 配额耗尽时提供降级策略
- 优化 API 调用，减少配额消耗
- 提供配额使用统计和预测

**适用边界**：
- 适用于所有 YouTube API 调用
- 适用于配额相关的监控和告警
- 不适用于非 API 操作（如本地数据库查询）

**隐含假设**：
- YouTube API 每日配额为 10,000 单位（可配置）
- 配额在每日 UTC 0:00 重置
- 不同 API 端点消耗不同配额（如 search=100, channels.list=1）

**常见失败模式**：
- 配额耗尽时系统完全不可用（无降级策略）
- 配额使用无监控，突然耗尽
- 无告警机制，无法提前准备
- 无优化措施，配额浪费严重

---

## 二、适用范围与边界

### 适用场景
- YouTube API 调用配额跟踪
- 配额使用率监控和告警
- 配额限流机制
- 批量请求优化（减少配额消耗）
- 配额使用统计和预测

### 不适用场景
- 本地数据库操作（不消耗配额）
- 向量计算（不消耗配额）
- 前端交互（不消耗配额）

---

## 三、完整检查点列表

### CP-y3-02：配额使用率监控
**检查点**：系统应实时监控配额使用率，提供 `/quota/usage-rate` API 端点。

### CP-y3-04：配额告警机制
**检查点**：系统应在配额使用率超过阈值（如 80%）时自动告警，并提供告警查询和确认功能。

### CP-y3-05：配额限流机制
**检查点**：系统应在配额使用率接近限制时自动限流，延迟 API 调用请求。

### CP-y3-09：批量请求优化
**检查点**：系统应使用批量 API 请求（如 `channels.list` 一次查询 50 个频道），减少配额消耗。

### CP-y3-10：配额使用统计
**检查点**：系统应提供配额使用统计信息，包括按端点统计、按天统计等。

### CP-y3-11：配额预测功能
**检查点**：系统应基于历史使用速率预测配额耗尽时间，提前告警。

### CP-y3-13：配额使用日志
**检查点**：系统应记录所有配额使用日志，支持查询和审计。

---

## 四、逐项逻辑检查

### CP-y3-02：配额使用率监控

#### 定义
验证系统实时监控配额使用率，提供 API 端点查询当前使用率。

#### 必要性分析
- **可观测性**：了解配额使用情况，避免突然耗尽
- **决策支持**：根据使用率调整系统行为
- **问题诊断**：配额异常时快速定位原因

**如果忽略**：
- 无法了解配额使用情况
- 配额耗尽时无法提前准备
- 无法优化配额使用策略

#### 验证方式
1. **代码审查**：
   - 检查 `infrastructure/quota_tracker.py` 中的 `get_quota_usage_rate()` 函数
   - 确认计算逻辑正确：`使用率 = 已使用配额 / 总配额 * 100`

2. **API 测试**：
   ```bash
   curl http://localhost:8000/quota/usage-rate
   ```
   验证返回 JSON 包含 `usage_rate` 字段（0-100）。

3. **功能测试**：
   - 执行多次 API 调用
   - 验证使用率实时更新

#### 通过标准
- ✅ **必须满足**：
  - `/quota/usage-rate` API 端点存在且可访问
  - 返回使用率在 0-100 范围内
  - 使用率计算准确（误差 < 1%）

- ⚠️ **应该满足**：
  - 使用率实时更新（延迟 < 5 秒）
  - 支持按 `use_for` 分别统计（index/search）

- 💡 **建议满足**：
  - 提供历史使用率趋势图
  - 支持预测未来使用率

---

### CP-y3-04：配额告警机制

#### 定义
验证系统在配额使用率超过阈值（如 80%）时自动告警，并提供告警查询和确认功能。

#### 必要性分析
- **提前预警**：在配额耗尽前通知管理员
- **问题处理**：给管理员时间采取行动（如申请更多配额）
- **审计追踪**：记录告警历史，便于分析

**如果忽略**：
- 配额耗尽时无预警，系统突然不可用
- 无法提前准备应对措施
- 无法分析配额使用模式

#### 验证方式
1. **代码审查**：
   - 检查 `infrastructure/quota_tracker.py` 中的 `check_and_record_quota_warning()` 函数
   - 确认告警阈值可配置（默认 80%）
   - 确认告警去重机制（避免频繁告警）

2. **功能测试**：
   ```python
   def test_quota_warning():
       # 1. 模拟配额使用率达到 80%
       # 2. 验证告警自动记录
       # 3. 验证告警可通过 API 查询
   ```

3. **API 测试**：
   ```bash
   curl http://localhost:8000/quota/warnings
   curl -X POST http://localhost:8000/quota/warnings/{id}/acknowledge
   ```

#### 通过标准
- ✅ **必须满足**：
  - 配额使用率超过阈值时自动记录告警
  - `/quota/warnings` API 端点存在且可访问
  - 告警包含：类型、使用率、时间、消息
  - 支持告警确认功能

- ⚠️ **应该满足**：
  - 告警阈值可配置（默认 80%）
  - 告警去重（同一时间段内不重复告警）
  - 告警记录持久化（数据库存储）

- 💡 **建议满足**：
  - 支持多种告警方式（日志、邮件、Webhook）
  - 支持告警级别（low/medium/high/critical）

---

### CP-y3-05：配额限流机制

#### 定义
验证系统在配额使用率接近限制时自动限流，延迟 API 调用请求，避免配额突然耗尽。

#### 必要性分析
- **平滑消耗**：避免配额突然耗尽，保证系统可用性
- **时间缓冲**：给管理员时间采取行动
- **资源保护**：保护剩余配额，用于关键操作

**如果忽略**：
- 配额可能突然耗尽，系统完全不可用
- 无法平滑分配配额使用
- 关键操作可能因配额耗尽而失败

#### 验证方式
1. **代码审查**：
   - 检查 `infrastructure/quota_tracker.py` 中的 `check_and_update_rate_limit()` 函数
   - 检查 `core/youtube_api.py` 中的限流检查逻辑
   - 确认限流阈值和延迟时间可配置

2. **功能测试**：
   ```python
   def test_rate_limiting():
       # 1. 模拟配额使用率达到限流阈值（如 90%）
       # 2. 验证 API 调用被延迟
       # 3. 验证延迟时间正确
   ```

3. **API 测试**：
   ```bash
   curl http://localhost:8000/quota/rate-limit
   ```
   验证返回限流状态信息。

#### 通过标准
- ✅ **必须满足**：
  - 配额使用率超过限流阈值时自动启用限流
  - API 调用被延迟（延迟时间可配置）
  - `/quota/rate-limit` API 端点存在且可访问

- ⚠️ **应该满足**：
  - 限流阈值可配置（默认 90%）
  - 延迟时间可配置（默认根据使用率动态计算）
  - 限流状态实时更新

- 💡 **建议满足**：
  - 支持按 `use_for` 分别限流
  - 支持限流优先级（关键操作优先）

---

### CP-y3-09：批量请求优化

#### 定义
验证系统使用批量 API 请求（如 `channels.list` 一次查询 50 个频道），减少配额消耗和请求次数。

#### 必要性分析
- **配额节省**：批量请求比单请求更高效（如 50 个频道 = 1 配额 vs 50 配额）
- **性能优化**：减少网络往返，提高响应速度
- **资源利用**：减少 API 服务器负载

**如果忽略**：
- 配额消耗增加 10-50 倍
- 请求响应时间增加
- API 服务器负载增加

#### 验证方式
1. **代码审查**：
   - 检查 `core/channel_info.py` 中的 `batch_get_channels_info()` 函数
   - 确认使用批量 API（`channels.list` 的 `id` 参数包含多个 ID）
   - 确认批量大小可配置（默认 50）

2. **性能测试**：
   ```python
   def test_batch_request_efficiency():
       # 1. 对比批量请求 vs 单请求的配额消耗
       # 2. 验证批量请求节省配额 > 90%
       # 3. 验证批量请求性能更好
   ```

3. **统计验证**：
   ```bash
   curl http://localhost:8000/quota/batch-stats
   ```
   验证批量请求统计信息。

#### 通过标准
- ✅ **必须满足**：
  - 所有频道信息查询使用批量 API
  - 批量大小可配置（默认 50）
  - 批量请求失败时回退到单请求

- ⚠️ **应该满足**：
  - 批量请求节省配额 > 90%（相比单请求）
  - 批量请求性能更好（响应时间减少 > 50%）
  - 批量请求统计信息准确

- 💡 **建议满足**：
  - 支持自适应批量大小（根据 API 响应调整）
  - 支持批量请求重试机制

---

### CP-y3-10：配额使用统计

#### 定义
验证系统提供详细的配额使用统计信息，包括按端点统计、按天统计、平均使用率等。

#### 必要性分析
- **数据分析**：了解配额使用模式，优化使用策略
- **容量规划**：预测未来配额需求
- **问题诊断**：定位配额异常使用

**如果忽略**：
- 无法了解配额使用模式
- 无法优化配额使用策略
- 无法预测未来配额需求

#### 验证方式
1. **代码审查**：
   - 检查 `infrastructure/quota_tracker.py` 中的 `get_quota_statistics()` 函数
   - 确认统计指标包括：总使用量、平均使用率、峰值使用率、按端点统计、按天统计

2. **API 测试**：
   ```bash
   curl http://localhost:8000/quota/statistics?days=7
   ```
   验证返回统计信息完整。

3. **数据验证**：
   - 执行多次 API 调用
   - 验证统计信息准确（与数据库记录一致）

#### 通过标准
- ✅ **必须满足**：
  - `/quota/statistics` API 端点存在且可访问
  - 返回统计信息包括：总使用量、平均使用率、峰值使用率
  - 支持按天数查询（1-30 天）

- ⚠️ **应该满足**：
  - 统计信息包括按端点统计
  - 统计信息包括按天统计
  - 统计信息实时更新

- 💡 **建议满足**：
  - 支持导出统计报告（CSV/JSON）
  - 支持可视化展示（图表）

---

### CP-y3-11：配额预测功能

#### 定义
验证系统基于历史使用速率预测配额耗尽时间，提前告警。

#### 必要性分析
- **提前预警**：在配额耗尽前预测，给管理员时间准备
- **决策支持**：根据预测调整系统行为
- **资源规划**：预测未来配额需求

**如果忽略**：
- 无法提前预测配额耗尽
- 无法提前采取应对措施
- 无法优化配额使用策略

#### 验证方式
1. **代码审查**：
   - 检查 `infrastructure/quota_tracker.py` 中的 `predict_quota_exhaustion()` 函数
   - 确认预测算法合理（基于最近 N 小时的使用速率）
   - 确认预测结果包含置信度说明

2. **API 测试**：
   ```bash
   curl http://localhost:8000/quota/prediction?lookback_hours=1
   ```
   验证返回预测信息。

3. **准确性测试**：
   ```python
   def test_quota_prediction_accuracy():
       # 1. 模拟配额使用历史
       # 2. 验证预测时间准确性（误差 < 2 小时）
   ```

#### 通过标准
- ✅ **必须满足**：
  - `/quota/prediction` API 端点存在且可访问
  - 返回预测信息包括：预测耗尽时间、剩余配额、使用速率
  - 预测算法基于历史使用速率

- ⚠️ **应该满足**：
  - 预测时间准确性（误差 < 2 小时）
  - 预测结果包含置信度说明
  - 支持按 `use_for` 分别预测

- 💡 **建议满足**：
  - 支持多种预测算法（线性、指数等）
  - 支持预测可视化（图表）

---

### CP-y3-13：配额使用日志

#### 定义
验证系统记录所有配额使用日志，支持查询和审计。

#### 必要性分析
- **审计追踪**：记录所有配额使用，便于审计
- **问题诊断**：定位配额异常使用
- **合规要求**：满足审计和合规要求

**如果忽略**：
- 无法追踪配额使用历史
- 无法定位配额异常使用
- 无法满足审计要求

#### 验证方式
1. **代码审查**：
   - 检查 `infrastructure/quota_tracker.py` 中的 `record_quota_usage()` 函数
   - 确认所有 API 调用都记录日志
   - 确认日志包含：端点、方法、消耗、时间、成功/失败

2. **API 测试**：
   ```bash
   curl http://localhost:8000/quota/logs?days=1&limit=100
   ```
   验证返回日志列表。

3. **数据验证**：
   - 执行多次 API 调用
   - 验证日志记录完整（所有调用都有记录）

#### 通过标准
- ✅ **必须满足**：
  - 所有 API 调用都记录日志
  - `/quota/logs` API 端点存在且可访问
  - 日志包含：端点、方法、消耗、时间、成功/失败

- ⚠️ **应该满足**：
  - 支持按天数查询（1-30 天）
  - 支持按成功/失败筛选
  - 支持分页查询（limit 参数）

- 💡 **建议满足**：
  - 支持日志导出（CSV/JSON）
  - 支持日志搜索和过滤

---

## 五、与其他规范的关系分析

### 与 y2（完备性）的关系
- **强依赖**：CP-y2-04（本地索引优先）直接减少配额消耗，是配额管理的基础
- **协同优化**：CP-y2-15（批量操作）可减少数据库查询，间接减少 API 调用

### 与 y4（数据一致性）的关系
- **潜在冲突**：配额管理要求减少 API 调用，但数据一致性要求及时更新数据
- **权衡方案**：使用 60 天过期策略，后台异步更新，平衡配额和数据新鲜度

### 与 y5（安全性）的关系
- **无直接冲突**：配额管理与安全性无直接关系

### 与 y6（代码质量）的关系
- **支持关系**：CP-y6-03（函数职责单一）有助于实现配额管理功能

---

## 六、检查清单总结

| 检查点 | 优先级 | 验证方式 | 通过标准 | 状态 |
|--------|--------|---------|---------|------|
| CP-y3-02 | P1 | API 测试 + 功能测试 | 使用率监控正常 | ⬜ |
| CP-y3-04 | P1 | 功能测试 + API 测试 | 告警机制正常 | ⬜ |
| CP-y3-05 | P1 | 功能测试 + API 测试 | 限流机制正常 | ⬜ |
| CP-y3-09 | P2 | 性能测试 + 统计验证 | 批量请求优化生效 | ⬜ |
| CP-y3-10 | P2 | API 测试 + 数据验证 | 统计功能完整 | ⬜ |
| CP-y3-11 | P2 | API 测试 + 准确性测试 | 预测功能准确 | ⬜ |
| CP-y3-13 | P2 | API 测试 + 数据验证 | 日志功能完整 | ⬜ |

**检查日期**：________  
**检查人员**：________  
**总体状态**：⬜ 通过 / ⬜ 部分通过 / ⬜ 未通过

