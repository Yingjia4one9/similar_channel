# y5：安全性检查清单

## 一、规范定义（工程化）

**安全性（Security）**：系统应防止常见安全攻击（XSS、SQL 注入、信息泄露等），保护用户数据和系统资源。

**工程化含义**：
- 所有用户输入经过验证和清理
- 所有数据库查询使用参数化查询
- 所有输出经过转义，防止 XSS
- 错误信息不泄露敏感数据
- 敏感数据（API 密钥、文件路径）经过脱敏处理

**适用边界**：
- 适用于所有用户输入（API 请求参数、前端输入）
- 适用于所有数据库操作
- 适用于所有错误处理和日志记录
- 不适用于第三方 API 的安全性（不可控）

**隐含假设**：
- 用户输入可能包含恶意代码
- 数据库可能受到 SQL 注入攻击
- 错误信息可能被攻击者利用
- 日志可能被未授权访问

**常见失败模式**：
- SQL 注入导致数据库被攻击
- XSS 攻击导致用户数据泄露
- 错误信息泄露系统内部信息
- 敏感数据在日志中明文记录

---

## 二、适用范围与边界

### 适用场景
- API 请求参数验证和清理
- 数据库查询（SQL 注入防护）
- 前端输出（XSS 防护）
- 错误处理和日志记录
- 敏感数据处理

### 不适用场景
- 第三方 API 的安全性（不可控）
- 网络传输安全（应由 HTTPS 保证）
- 操作系统安全（应由系统管理员保证）

---

## 三、完整检查点列表

### CP-y5-06：SQL 注入防护
**检查点**：所有 SQL 查询必须使用参数化查询，禁止字符串拼接。

### CP-y5-07：XSS 防护
**检查点**：所有用户输入必须经过验证和清理，所有输出必须经过转义。

### CP-y5-11：敏感数据脱敏
**检查点**：所有敏感数据（API 密钥、文件路径）在日志中必须脱敏处理。

### CP-y5-13：错误信息安全
**检查点**：所有错误信息不泄露敏感数据或系统内部信息。

---

## 四、逐项逻辑检查

### CP-y5-06：SQL 注入防护

#### 定义
验证所有 SQL 查询使用参数化查询（使用 `?` 占位符或命名参数），禁止字符串拼接。

#### 必要性分析
- **安全要求**：SQL 注入是最常见的安全漏洞之一
- **数据保护**：防止数据库被攻击者控制
- **合规要求**：满足安全审计要求

**如果忽略**：
- 攻击者可通过恶意输入执行任意 SQL 语句
- 数据库可能被完全控制（读取、修改、删除数据）
- 系统完全不可信

#### 验证方式
1. **代码审查**：
   - 检查所有数据库操作代码（`infrastructure/database.py`, `scripts/build_channel_index.py` 等）
   - 使用工具扫描，查找字符串拼接的 SQL 语句
   - 确认所有 `execute()` 调用使用参数化查询

2. **自动化扫描**：
   ```python
   # 使用 verify_p0_tasks.py 脚本
   python scripts/verify_p0_tasks.py
   ```
   验证所有 SQL 查询使用参数化查询。

3. **渗透测试**：
   ```python
   def test_sql_injection_protection():
       # 尝试 SQL 注入攻击
       malicious_input = "'; DROP TABLE channels; --"
       # 验证攻击失败，数据不受影响
   ```

#### 通过标准
- ✅ **必须满足**：
  - 所有 SQL 查询使用参数化查询（`?` 占位符或命名参数）
  - 无字符串拼接的 SQL 语句
  - 所有 `execute()` 调用使用参数化查询

- ⚠️ **应该满足**：
  - 代码审查工具扫描无 SQL 注入风险
  - 渗透测试无 SQL 注入漏洞

- 💡 **建议满足**：
  - 使用 ORM 或查询构建器（进一步降低风险）
  - 定期进行安全审计

---

### CP-y5-07：XSS 防护

#### 定义
验证所有用户输入经过验证和清理，所有输出经过转义，防止 XSS 攻击。

#### 必要性分析
- **安全要求**：XSS 攻击可窃取用户数据、劫持用户会话
- **用户保护**：保护用户免受恶意脚本攻击
- **合规要求**：满足 Web 安全标准

**如果忽略**：
- 攻击者可通过恶意输入注入 JavaScript 代码
- 用户数据可能被窃取
- 用户会话可能被劫持

#### 验证方式
1. **代码审查**：
   - 检查 `infrastructure/xss_protection.py` 中的 `validate_and_sanitize_request()` 函数
   - 检查 `app/main.py` 中的 XSS 防护中间件
   - 检查前端 `frontend.html` 中的 `escapeHtml()` 函数

2. **功能测试**：
   ```python
   def test_xss_protection():
       # 尝试 XSS 攻击
       malicious_input = "<script>alert('XSS')</script>"
       # 验证输入被清理
       # 验证输出被转义
   ```

3. **前端测试**：
   ```javascript
   // 测试前端转义
   const malicious = "<script>alert('XSS')</script>";
   const escaped = escapeHtml(malicious);
   // 验证 escaped 不包含 <script> 标签
   ```

#### 通过标准
- ✅ **必须满足**：
  - 所有用户输入经过 `validate_and_sanitize_request()` 处理
  - 所有前端输出经过 `escapeHtml()` 转义
  - HTTP 响应头包含安全头（CSP, X-Frame-Options 等）

- ⚠️ **应该满足**：
  - XSS 攻击测试失败（攻击被阻止）
  - 安全头正确配置

- 💡 **建议满足**：
  - 支持内容安全策略（CSP）白名单
  - 支持 XSS 攻击日志记录

---

### CP-y5-11：敏感数据脱敏

#### 定义
验证所有敏感数据（API 密钥、文件路径）在日志中经过脱敏处理，不泄露敏感信息。

#### 必要性分析
- **数据保护**：防止敏感信息泄露
- **合规要求**：满足数据保护法规要求
- **安全审计**：日志可能被未授权访问

**如果忽略**：
- API 密钥可能泄露，导致配额被盗用
- 文件路径可能泄露系统结构
- 违反数据保护法规

#### 验证方式
1. **代码审查**：
   - 检查 `infrastructure/utils.py` 中的 `sanitize_file_path()` 函数
   - 检查所有日志记录代码，确认敏感数据脱敏
   - 确认 API 密钥不在日志中明文记录

2. **日志检查**：
   ```python
   def test_sensitive_data_sanitization():
       # 记录包含敏感数据的日志
       # 验证日志中敏感数据被脱敏
   ```

3. **自动化扫描**：
   - 扫描所有日志记录代码
   - 确认无 API 密钥、密码等敏感信息明文记录

#### 通过标准
- ✅ **必须满足**：
  - 所有文件路径经过脱敏处理（`sanitize_file_path()`）
  - API 密钥不在日志中明文记录
  - 敏感数据脱敏函数正确实现

- ⚠️ **应该满足**：
  - 日志扫描无敏感信息泄露
  - 脱敏后的数据仍可用于调试（保留部分信息）

- 💡 **建议满足**：
  - 支持配置敏感数据脱敏规则
  - 支持敏感数据检测和告警

---

### CP-y5-13：错误信息安全

#### 定义
验证所有错误信息不泄露敏感数据或系统内部信息，仅返回用户友好的错误消息。

#### 必要性分析
- **安全要求**：错误信息可能被攻击者利用
- **信息保护**：防止系统内部信息泄露
- **用户体验**：用户友好的错误消息

**如果忽略**：
- 错误信息可能泄露系统结构、数据库结构
- 攻击者可能利用错误信息进行攻击
- 用户体验差（技术性错误消息）

#### 验证方式
1. **代码审查**：
   - 检查 `app/main.py` 中的错误处理代码
   - 检查 `infrastructure/error_handler.py` 中的错误处理函数
   - 确认所有异常捕获后返回用户友好的错误消息

2. **功能测试**：
   ```python
   def test_error_message_security():
       # 触发各种错误（数据库错误、API 错误等）
       # 验证错误消息不泄露敏感信息
       # 验证错误消息用户友好
   ```

3. **渗透测试**：
   - 尝试各种错误场景
   - 验证错误消息不泄露系统内部信息

#### 通过标准
- ✅ **必须满足**：
  - 所有 API 错误返回用户友好的错误消息
  - 错误消息不包含敏感数据（API 密钥、文件路径、数据库结构等）
  - 详细错误信息仅记录在日志中（不返回给用户）

- ⚠️ **应该满足**：
  - 错误消息包含错误类型和解决建议
  - 错误消息支持多语言（如中文、英文）

- 💡 **建议满足**：
  - 支持错误消息模板配置
  - 支持错误消息国际化

---

## 五、与其他规范的关系分析

### 与 y2（完备性）的关系
- **无直接冲突**：安全性与完备性可并行实现
- **协同优化**：安全功能（如输入验证）也是功能完备性的要求

### 与 y3（配额管理）的关系
- **无直接冲突**：安全性与配额管理无直接关系

### 与 y4（数据一致性）的关系
- **无直接冲突**：安全性与数据一致性无直接关系

### 与 y6（代码质量）的关系
- **强依赖**：安全性要求通过代码质量保证（如统一错误处理）

---

## 六、检查清单总结

| 检查点 | 优先级 | 验证方式 | 通过标准 | 状态 |
|--------|--------|---------|---------|------|
| CP-y5-06 | P0 | 代码审查 + 自动化扫描 | SQL 注入防护生效 | ⬜ |
| CP-y5-07 | P0 | 代码审查 + 功能测试 | XSS 防护生效 | ⬜ |
| CP-y5-11 | P2 | 代码审查 + 日志检查 | 敏感数据脱敏处理 | ⬜ |
| CP-y5-13 | P2 | 代码审查 + 功能测试 | 错误信息不泄露敏感数据 | ⬜ |

**检查日期**：________  
**检查人员**：________  
**总体状态**：⬜ 通过 / ⬜ 部分通过 / ⬜ 未通过

