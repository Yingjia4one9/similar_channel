# y4：数据一致性检查清单

## 一、规范定义（工程化）

**数据一致性（Data Consistency）**：系统应保证本地存储的数据（频道信息、向量索引）与 YouTube API 数据保持一致，或在可接受的时间窗口内同步。

**工程化含义**：
- 本地数据与 API 数据在合理时间窗口内一致（如 60 天）
- 数据过期时自动更新或标记过期
- 向量索引与频道信息保持一致
- 数据库事务保证原子性
- 数据更新失败时有回滚机制

**适用边界**：
- 适用于本地数据库存储的频道信息
- 适用于 FAISS 向量索引
- 适用于频道信息与向量的对应关系
- 不适用于实时 API 数据（总是最新的）

**隐含假设**：
- YouTube API 数据是权威数据源
- 频道信息变化频率较低（大多数频道信息不会频繁变化）
- 60 天过期策略是可接受的（平衡配额和数据新鲜度）

**常见失败模式**：
- 本地数据过期但未更新，返回错误信息
- 向量索引与频道信息不同步（频道信息更新但向量未更新）
- 数据更新失败但未回滚，导致数据不一致
- 并发更新导致数据覆盖或丢失

---

## 二、适用范围与边界

### 适用场景
- 本地数据库中的频道信息
- FAISS 向量索引
- 频道信息与向量的对应关系
- 数据更新和同步机制

### 不适用场景
- 实时 API 数据（总是最新的，无需一致性检查）
- 前端缓存数据（由浏览器管理）
- 临时计算结果（不持久化）

---

## 三、完整检查点列表

### CP-y4-02：索引数据自动更新
**检查点**：系统应自动检测过期数据（超过 60 天），并在后台异步更新，不阻塞当前查询。

### CP-y4-09：向量与信息一致性
**检查点**：系统应保证向量索引与频道信息保持一致，频道信息更新时向量也应更新。

---

## 四、逐项逻辑检查

### CP-y4-02：索引数据自动更新

#### 定义
验证系统自动检测过期数据（超过配置的天数，默认 60 天），并在后台异步更新，不阻塞当前查询。

#### 必要性分析
- **数据新鲜度**：保证本地数据不会过于陈旧
- **用户体验**：过期数据更新不阻塞当前查询，保证响应速度
- **配额优化**：异步更新可批量处理，减少 API 调用

**如果忽略**：
- 本地数据可能过于陈旧，返回错误信息
- 数据更新阻塞查询，影响用户体验
- 无法有效利用配额进行数据更新

#### 验证方式
1. **代码审查**：
   - 检查 `infrastructure/database.py` 中的 `get_channel_info_from_local_db()` 函数
   - 确认过期检测逻辑（`updated_at` 字段与当前时间比较）
   - 确认异步更新机制（`_trigger_async_update_expired_channels()` 函数）

2. **功能测试**：
   ```python
   def test_auto_update_expired_data():
       # 1. 创建过期数据（updated_at > 60 天前）
       # 2. 查询该数据
       # 3. 验证查询不阻塞
       # 4. 验证后台异步更新触发
   ```

3. **集成测试**：
   - 模拟过期数据查询
   - 验证查询立即返回（不等待更新）
   - 验证后台更新任务启动

#### 通过标准
- ✅ **必须满足**：
  - 过期数据检测逻辑正确（基于 `updated_at` 字段）
  - 过期数据查询不阻塞（立即返回，后台更新）
  - 过期阈值可配置（默认 60 天）

- ⚠️ **应该满足**：
  - 异步更新机制正常工作（后台任务启动）
  - 更新失败时有重试机制
  - 更新进度可追踪

- 💡 **建议满足**：
  - 支持手动触发更新
  - 支持批量更新过期数据
  - 支持更新优先级（重要频道优先）

---

### CP-y4-09：向量与信息一致性

#### 定义
验证系统保证向量索引与频道信息保持一致，频道信息更新时向量也应更新。

#### 必要性分析
- **搜索准确性**：向量与信息不一致会导致搜索结果不准确
- **数据完整性**：向量应基于最新的频道信息计算
- **系统可靠性**：不一致数据会导致系统行为异常

**如果忽略**：
- 搜索结果不准确（基于旧信息计算的向量）
- 数据不一致导致系统行为异常
- 无法保证数据完整性

#### 验证方式
1. **代码审查**：
   - 检查 `infrastructure/database.py` 中的 `check_vector_info_consistency()` 函数
   - 检查 `recalculate_vectors_for_channels()` 函数
   - 确认频道信息更新时同步更新向量

2. **一致性检查**：
   ```python
   def test_vector_info_consistency():
       # 1. 检查所有频道的向量与信息一致性
       # 2. 验证不一致的频道被标记
       # 3. 验证重新计算向量功能正常
   ```

3. **更新测试**：
   ```python
   def test_vector_update_on_info_change():
       # 1. 更新频道信息
       # 2. 验证向量自动更新
       # 3. 验证更新后的向量与信息一致
   ```

#### 通过标准
- ✅ **必须满足**：
  - 一致性检查函数存在且可调用
  - 频道信息更新时向量同步更新
  - 不一致数据可被检测和修复

- ⚠️ **应该满足**：
  - 一致性检查性能可接受（10,000 频道 < 10 秒）
  - 向量重新计算功能正常
  - 更新失败时有回滚机制

- 💡 **建议满足**：
  - 支持定期自动一致性检查
  - 支持不一致数据自动修复
  - 支持一致性检查报告

---

## 五、与其他规范的关系分析

### 与 y2（完备性）的关系
- **强依赖**：CP-y2-04（本地索引优先）要求数据一致性，否则返回错误数据
- **协同优化**：CP-y2-15（批量操作）有助于数据一致性（批量更新保证原子性）

### 与 y3（配额管理）的关系
- **潜在冲突**：数据一致性要求及时更新，但配额管理要求减少 API 调用
- **权衡方案**：使用 60 天过期策略，后台异步更新，平衡数据新鲜度和配额消耗

### 与 y5（安全性）的关系
- **无直接冲突**：数据一致性与安全性无直接关系

### 与 y6（代码质量）的关系
- **支持关系**：CP-y6-03（函数职责单一）有助于实现数据一致性功能

---

## 六、检查清单总结

| 检查点 | 优先级 | 验证方式 | 通过标准 | 状态 |
|--------|--------|---------|---------|------|
| CP-y4-02 | P1 | 功能测试 + 集成测试 | 自动更新机制正常 | ⬜ |
| CP-y4-09 | P1 | 一致性检查 + 更新测试 | 向量与信息一致 | ⬜ |

**检查日期**：________  
**检查人员**：________  
**总体状态**：⬜ 通过 / ⬜ 部分通过 / ⬜ 未通过

